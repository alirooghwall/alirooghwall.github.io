<!DOCTYPE HTML>
<html>
	<head>
		<title>MLM Tree | MARS EMPIRE</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<script src="https://d3js.org/d3.v7.min.js"></script>
		<style>
			.node circle { fill: #fff; stroke: steelblue; stroke-width: 3px; }
			.node text { font: 12px sans-serif; fill: #333; }
			.link { fill: none; stroke: #ccc; stroke-width: 2px; }
			body { background: #f4f4f4; color: #333; }
			main { background: #fff; margin: 2rem auto; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 1200px; }
			h1 { color: #2a2a3e; text-align: center; }
			#tree { display: flex; justify-content: center; }
		</style>
	</head>
	<body class="is-preload">
		<div id="wrapper" class="fade-in">
			<header id="header">
				<a href="/" class="logo">MARS EMPIRE</a>
				<nav>
					<a href="#menu">Menu</a>
				</nav>
			</header>
			<nav id="menu">
				<ul class="links">
					<li><a href="/">Home</a></li>
					<li><a href="/dashboard">Dashboard</a></li>
					<li><a href="/rules">Rules</a></li>
					<li><a href="/articles">Articles</a></li>
					<li><a href="/resources">Resources</a></li>
					<li><a href="/checklists">Checklists</a></li>
					<li class="active"><a href="/tree">Tree</a></li>
					<li><a href="/calculator">Calculator</a></li>
					<li><a href="/leaderboard">Leaderboard</a></li>
					<% if (user.accountType === 'admin' || user.accountType === 'master_admin') { %>
					<li><a href="/admin">Admin</a></li>
					<% } %>
				</ul>
				<ul class="actions stacked">
					<li><a href="/profile" class="button primary fit">Profile</a></li>
					<li><form method="post" action="/logout"><button type="submit" class="button fit">Logout</button></form></li>
				</ul>
			</nav>
			<div style="text-align: center; margin: 1rem;"><button onclick="history.back()" class="button">‚Üê Back</button></div>
			<div id="main">
				<article class="post featured">
					<header class="major">
						<h1>MLM Hierarchy Tree</h1>
					</header>
					<div id="tree"></div>
					<% if (user && user.accountType === 'admin') { %>
						<section>
							<h2>Pending Connections</h2>
							<ul>
								<% pendingConnections.forEach(t => { %>
									<li><%= t.userId %> under <%= t.leaderId %>
										<form method="post" action="/tree/verify/<%= t._id %>" style="display:inline;">
											<button type="submit">Verify</button>
										</form>
									</li>
								<% }); %>
							</ul>
						</section>
					<% } %>
				</article>
			</div>
			<%- include('footer') %>
		</div>
		<script type="application/json" id="tree-data"><%- JSON.stringify(treeData) %></script>
		<script>
			const treeData = JSON.parse(document.getElementById('tree-data').textContent);
			const width = 800;
			const height = 600;
			const svg = d3.select('#tree').append('svg').attr('width', width).attr('height', height);
			const g = svg.append('g').attr('transform', 'translate(40,0)');
			const treeLayout = d3.tree().size([height - 100, width - 160]);
			const root = d3.hierarchy(treeData);
			treeLayout(root);
			g.selectAll('.link')
				.data(root.links())
				.enter().append('path')
				.attr('class', 'link')
				.attr('d', d3.linkHorizontal().x(d => d.y).y(d => d.x));
			const node = g.selectAll('.node')
				.data(root.descendants())
				.enter().append('g')
				.attr('class', 'node')
				.attr('transform', d => `translate(${d.y},${d.x})`);
			node.append('circle').attr('r', 10);
			node.append('text')
				.attr('dy', '.35em')
				.attr('x', d => d.children ? -13 : 13)
				.style('text-anchor', d => d.children ? 'end' : 'start')
				.text(d => d.data.name);
		</script>
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>
	</body>
</html>