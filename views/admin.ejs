<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | MARS EMPIRE</title>
  <link rel="stylesheet" href="/assets/css/main.css">
  <style>
    body { background: linear-gradient(135deg, #1e1e2e, #2a2a3e); color: #ffffff; font-family: 'Source Sans Pro', sans-serif; margin: 0; padding: 0; }
    main { color: #ffffff; }
    .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 1rem; }
    .tab { padding: 0.5rem 1rem; cursor: pointer; background: #333; color: #fff; border: 1px solid #ccc; border-bottom: none; }
    .tab.active { background: #555; border-bottom: 1px solid #555; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .crud-btn { margin-left: 0.5rem; }
    input, select, textarea { margin: 0.2rem; width: 200px; background: #f9f9f9; color: #000; border: 1px solid #ccc; padding: 0.5rem; border-radius: 4px; }
    textarea { width: 300px; height: 100px; }
    button { background: linear-gradient(45deg, #4ecdc4, #45b7aa); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
    button:hover { background: linear-gradient(45deg, #45b7aa, #3da08e); }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 1rem; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; }
    form { display: inline; }
  </style>
</head>
<body>
  <main style="max-width:1200px;margin:3rem auto;padding:1rem;">
    <h1>Admin Dashboard</h1>
    
    <div class="tabs">
      <div class="tab active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="users">User Management</div>
      <div class="tab" data-tab="content">Content</div>
      <div class="tab" data-tab="tree">Tree</div>
      <div class="tab" data-tab="settings">Settings</div>
    </div>
    
    <div style="text-align: center; margin: 1rem;"><button onclick="history.back()" class="button">‚Üê Back</button></div>
    
    <div id="overview" class="tab-content active">
      <h2>Overview</h2>
      <p>Welcome to the admin dashboard. Use the tabs above to manage different aspects of the system.</p>
      <p>Total Users: <%= allUsers.length %></p>
      <p>Pending Approvals: <%= pendingUsers.length %></p>
      <p>Verified Tree Connections: <%= treeConnections.length %></p>
    </div>
    
    <div id="users" class="tab-content">
      <h2>Create New User</h2>
      <form id="create-user-form" action="/admin/create-user" method="post">
        <input name="name" placeholder="Name" required />
        <input name="email" type="email" placeholder="Email" required />
        <input name="password" placeholder="Password" required />
        <input name="phone" placeholder="Phone" />
        <input name="leaderName" placeholder="Leader Name" />
        <select name="accountType" required>
          <option value="participant" selected>Participant</option>
          <option value="student">Student</option>
          <option value="editor">Editor</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
          <option value="master_admin">Master Admin</option>
        </select>
        <label>Permissions:</label><br>
        <input type="checkbox" name="permissions" value="view_users" /> View Users<br>
        <input type="checkbox" name="permissions" value="edit_content" /> Edit Content<br>
        <input type="checkbox" name="permissions" value="upload_files" /> Upload Files<br>
        <input type="checkbox" name="permissions" value="view_reports" /> View Reports<br>
        <input type="checkbox" name="permissions" value="view_logs" /> View Logs<br>
        <select name="mlmLevel" required>
          <option value="beginner" selected>Beginner</option>
          <option value="intermediate">Intermediate</option>
          <option value="advanced">Advanced</option>
          <option value="expert">Expert</option>
        </select>
        <button type="button" onclick="submitForm('create-user-form')">Create User</button>
      </form>
      
      <h2>Pending Approvals</h2>
      <section class="posts">
        <% pendingUsers.forEach(u => { %>
          <article>
            <header>
              <h3><%= u.name %> (<%= u.email %>)</h3>
            </header>
            <form id="edit-user-<%= u._id %>" action="/admin/edit-user/<%= u._id %>" method="post">
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                <input name="name" value="<%= u.name %>" placeholder="Name" required style="flex: 1; min-width: 150px;" />
                <input name="email" value="<%= u.email %>" placeholder="Email" required style="flex: 1; min-width: 150px;" />
                <input name="phone" value="<%= u.phone %>" placeholder="Phone" style="flex: 1; min-width: 150px;" />
                <input name="leaderName" value="<%= u.leaderName %>" placeholder="Leader Name" style="flex: 1; min-width: 150px;" />
                <select name="accountType" style="flex: 1; min-width: 150px;">
                  <option value="student" <%= u.accountType==='student'?'selected':'' %>>Student</option>
                  <option value="participant" <%= u.accountType==='participant'?'selected':'' %>>Participant</option>
                  <option value="editor" <%= u.accountType==='editor'?'selected':'' %>>Editor</option>
                  <option value="manager" <%= u.accountType==='manager'?'selected':'' %>>Manager</option>
                  <option value="admin" <%= u.accountType==='admin'?'selected':'' %>>Admin</option>
                </select>
                <input name="mlmLevel" value="<%= u.mlmLevel %>" placeholder="MLM Level" style="flex: 1; min-width: 150px;" />
              </div>
              <ul class="actions special">
                <li><button type="button" onclick="submitForm('edit-user-<%= u._id %>')">Edit</button></li>
                <li><button type="button" onclick="submitForm('approve-<%= u._id %>')">Approve</button></li>
                <li><button type="button" onclick="submitForm('reject-<%= u._id %>')">Reject</button></li>
                <li><button type="button" onclick="submitForm('delete-user-<%= u._id %>')">Delete</button></li>
              </ul>
            </form>
            <form id="approve-<%= u._id %>" action="/admin/approve/<%= u._id %>" style="display:none;"></form>
            <form id="reject-<%= u._id %>" action="/admin/reject/<%= u._id %>" style="display:none;"></form>
            <form id="delete-user-<%= u._id %>" action="/admin/delete-user/<%= u._id %>" style="display:none;"></form>
          </article>
        <% }); %>
      </section>
      
      <h2>All Users</h2>
      <section class="posts">
        <% allUsers.forEach(u => { %>
          <article>
            <header>
              <h3><%= u.name %> (<%= u.email %>)</h3>
            </header>
            <form id="edit-user-all-<%= u._id %>" action="/admin/edit-user/<%= u._id %>" method="post">
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                <input name="name" value="<%= u.name %>" placeholder="Name" required style="flex: 1; min-width: 150px;" />
                <input name="email" value="<%= u.email %>" placeholder="Email" required style="flex: 1; min-width: 150px;" />
                <input name="phone" value="<%= u.phone %>" placeholder="Phone" style="flex: 1; min-width: 150px;" />
                <input name="leaderName" value="<%= u.leaderName %>" placeholder="Leader Name" style="flex: 1; min-width: 150px;" />
                <select name="accountType" style="flex: 1; min-width: 150px;">
                  <option value="student" <%= u.accountType==='student'?'selected':'' %>>Student</option>
                  <option value="participant" <%= u.accountType==='participant'?'selected':'' %>>Participant</option>
                  <option value="editor" <%= u.accountType==='editor'?'selected':'' %>>Editor</option>
                  <option value="manager" <%= u.accountType==='manager'?'selected':'' %>>Manager</option>
                  <option value="admin" <%= u.accountType==='admin'?'selected':'' %>>Admin</option>
                  <option value="master_admin" <%= u.accountType==='master_admin'?'selected':'' %>>Master Admin</option>
                </select>
                <input name="mlmLevel" value="<%= u.mlmLevel %>" placeholder="MLM Level" style="flex: 1; min-width: 150px;" />
              </div>
              <ul class="actions special">
                <li><button type="button" onclick="submitForm('edit-user-all-<%= u._id %>')">Edit</button></li>
                <li><button type="button" onclick="submitForm('delete-user-all-<%= u._id %>')">Delete</button></li>
              </ul>
            </form>
            <form id="delete-user-all-<%= u._id %>" action="/admin/delete-user/<%= u._id %>" style="display:none;"></form>
          </article>
        <% }); %>
      </section>
    </div>
    
    <div id="content" class="tab-content">
      <h2>Rules</h2>
      <form id="create-rule-form" action="/rules/create" method="post">
        <input name="title" placeholder="Title" required />
        <textarea name="content" placeholder="Content"></textarea>
        <input name="category" placeholder="Category" />
        <button type="button" onclick="submitForm('create-rule-form')">Create Rule</button>
      </form>
      <ul>
        <% rules.forEach(r => { %>
          <li>
            <form id="update-rule-<%= r._id %>" action="/rules/update/<%= r._id %>" method="post" style="display:inline;">
              <input name="title" value="<%= r.title %>" required />
              <textarea name="content"><%= r.content %></textarea>
              <input name="category" value="<%= r.category %>" />
              <button type="button" onclick="submitForm('update-rule-<%= r._id %>')" class="crud-btn">Update</button>
            </form>
            <form id="delete-rule-<%= r._id %>" action="/rules/delete/<%= r._id %>" method="post" style="display:inline;">
              <button type="button" onclick="submitForm('delete-rule-<%= r._id %>')" class="crud-btn">Delete</button>
            </form>
          </li>
        <% }); %>
      </ul>
      
      <h2>Articles</h2>
      <form id="create-article-form" action="/articles/create" method="post">
        <input name="title" placeholder="Title" required />
        <textarea name="content" placeholder="Content"></textarea>
        <input name="category" placeholder="Category" />
        <input name="tags" placeholder="Tags (comma separated)" />
        <label><input name="published" type="checkbox" /> Published</label>
        <input name="files" type="file" multiple />
        <button type="button" onclick="submitForm('create-article-form')">Create Article</button>
      </form>
      <ul>
        <% articles.forEach(a => { %>
          <li>
            <form id="update-article-<%= a._id %>" action="/articles/update/<%= a._id %>" method="post" style="display:inline;">
              <input name="title" value="<%= a.title %>" required />
              <textarea name="content"><%= a.content %></textarea>
              <input name="category" value="<%= a.category %>" />
              <input name="tags" value="<%= a.tags.join(',') %>" />
              <label><input name="published" type="checkbox" <%= a.published?'checked':'' %> /> Published</label>
              <button type="button" onclick="submitForm('update-article-<%= a._id %>')" class="crud-btn">Update</button>
            </form>
            <form id="delete-article-<%= a._id %>" action="/articles/delete/<%= a._id %>" method="post" style="display:inline;">
              <button type="button" onclick="submitForm('delete-article-<%= a._id %>')" class="crud-btn">Delete</button>
            </form>
          </li>
        <% }); %>
      </ul>
      
      <h2>Resources</h2>
      <form id="create-resource-form" action="/resources/create" method="post">
        <input name="title" placeholder="Title" required />
        <textarea name="description" placeholder="Description"></textarea>
        <select name="type">
          <option value="document">Document</option>
          <option value="video">Video</option>
          <option value="link">Link</option>
          <option value="file">File</option>
        </select>
        <input name="url" placeholder="URL" />
        <input name="file" type="file" />
        <input name="category" placeholder="Category" />
        <select name="accessLevel">
          <option value="public">Public</option>
          <option value="participants">Participants</option>
          <option value="managers">Managers</option>
        </select>
        <button type="button" onclick="submitForm('create-resource-form')">Create Resource</button>
      </form>
      <ul>
        <% resources.forEach(res => { %>
          <li>
            <form id="update-resource-<%= res._id %>" action="/resources/update/<%= res._id %>" method="post" style="display:inline;">
              <input name="title" value="<%= res.title %>" required />
              <textarea name="description"><%= res.description %></textarea>
              <select name="type">
                <option value="document" <%= res.type==='document'?'selected':'' %>>Document</option>
                <option value="video" <%= res.type==='video'?'selected':'' %>>Video</option>
                <option value="link" <%= res.type==='link'?'selected':'' %>>Link</option>
                <option value="file" <%= res.type==='file'?'selected':'' %>>File</option>
              </select>
              <input name="url" value="<%= res.url %>" />
              <input name="category" value="<%= res.category %>" />
              <select name="accessLevel">
                <option value="public" <%= res.accessLevel==='public'?'selected':'' %>>Public</option>
                <option value="participants" <%= res.accessLevel==='participants'?'selected':'' %>>Participants</option>
                <option value="managers" <%= res.accessLevel==='managers'?'selected':'' %>>Managers</option>
              </select>
              <button type="button" onclick="submitForm('update-resource-<%= res._id %>')" class="crud-btn">Update</button>
            </form>
            <form id="delete-resource-<%= res._id %>" action="/resources/delete/<%= res._id %>" method="post" style="display:inline;">
              <button type="button" onclick="submitForm('delete-resource-<%= res._id %>')" class="crud-btn">Delete</button>
            </form>
          </li>
        <% }); %>
      </ul>
    </div>
    
    <div id="tree" class="tab-content">
      <h2>Tree Connections</h2>
      <ul>
        <% treeConnections.forEach(t => { %>
          <li>
            <form id="edit-tree-<%= t._id %>" action="/admin/edit-tree/<%= t._id %>" method="post" style="display:inline;">
              <input name="userId" value="<%= t.userId %>" required />
              <input name="leaderId" value="<%= t.leaderId %>" />
              <select name="verified">
                <option value="true" <%= t.verified?'selected':'' %>>Verified</option>
                <option value="false" <%= !t.verified?'selected':'' %>>Not Verified</option>
              </select>
              <button type="button" onclick="submitForm('edit-tree-<%= t._id %>')" class="crud-btn">Edit</button>
            </form>
            <form id="delete-tree-<%= t._id %>" action="/admin/delete-tree/<%= t._id %>" method="post" style="display:inline;">
              <button type="button" onclick="submitForm('delete-tree-<%= t._id %>')" class="crud-btn">Delete</button>
            </form>
          </li>
        <% }); %>
      </ul>
    </div>
    
    <div id="settings" class="tab-content">
      <h2>Settings</h2>
      <a href="/settings">Manage Settings</a>
    </div>
    
    <a href="/profile">Back to Profile</a>
  </main>
  <%- include('footer') %>
  
  <script>
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });
    function submitForm(id) {
      const form = document.getElementById(id);
      showLoader(true);
      fetch(form.action, {
        method: 'POST',
        credentials: 'include',
        body: new FormData(form)
      }).then(response => {
        if (response.ok) {
          showToast('success', 'Saved successfully');
          location.reload();
        } else {
          showToast('error', 'Error: ' + response.status);
        }
      }).catch(err => {
        console.error('Error:', err);
        showToast('error', 'Error submitting form');
      }).finally(() => showLoader(false));
    }
  </script>
</body>
</html>