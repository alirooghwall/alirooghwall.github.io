<!DOCTYPE HTML>
<html>
	<head>
		<title>Checklists | MARS EMPIRE</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<style>
			body { background: #f4f4f4; color: #333; }
			main { background: #fff; margin: 2rem auto; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 1000px; }
			h1 { color: #2a2a3e; text-align: center; }
			h2 { color: #4ecdc4; }
			.checklist { margin-bottom: 2rem; }
			.progress-bar { width: 100%; background-color: #f0f0f0; border-radius: 5px; overflow: hidden; height: 20px; margin: 10px 0; }
			.progress-fill { height: 100%; background-color: #4ecdc4; transition: width 0.3s; }
			.progress-text { text-align: center; font-size: 14px; margin-bottom: 10px; }
			ul { list-style: none; padding: 0; }
			li { margin-bottom: 0.5rem; display: flex; align-items: center; }
			input[type="checkbox"] { margin-right: 0.5rem; }
			form { margin-top: 2rem; }
			input, textarea, button { display: block; width: 100%; margin-bottom: 1rem; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
			button { background: #4ecdc4; color: white; border: none; cursor: pointer; }
			button:hover { background: #45b7aa; }
		</style>
	</head>
	<body class="is-preload">
		<div id="wrapper" class="fade-in">
			<header id="header">
				<a href="/" class="logo">MARS EMPIRE</a>
				<nav>
					<a href="#menu">Menu</a>
				</nav>
			</header>
			<nav id="menu">
				<ul class="links">
					<li><a href="/">Home</a></li>
					<li><a href="/dashboard">Dashboard</a></li>
					<li><a href="/rules">Rules</a></li>
					<li><a href="/articles">Articles</a></li>
					<li><a href="/resources">Resources</a></li>
					<li class="active"><a href="/checklists">Checklists</a></li>
					<li><a href="/tree">Tree</a></li>
					<li><a href="/calculator">Calculator</a></li>
					<li><a href="/leaderboard">Leaderboard</a></li>
					<% if (user.accountType === 'admin' || user.accountType === 'master_admin') { %>
					<li><a href="/admin">Admin</a></li>
					<% } %>
				</ul>
				<ul class="actions stacked">
					<li><a href="/profile" class="button primary fit">Profile</a></li>
					<li><form method="post" action="/logout"><button type="submit" class="button fit">Logout</button></form></li>
				</ul>
			</nav>
			<div style="text-align: center; margin: 1rem;"><button onclick="history.back()" class="button">‚Üê Back</button></div>
			<div id="main">
				<article class="post featured">
					<header class="major">
						<h1>Checklists</h1>
					</header>
					<% predefined.forEach(c => { %>
						<% const percent = Math.round((c.items.filter(item => item.completed).length / c.items.length) * 100); %>
						<% const style = `width: ${percent}%`; %>
						<section class="checklist">
							<h2><%= c.title %></h2>
							<div class="progress-text"><%= c.items.filter(item => item.completed).length %>/<%= c.items.length %> completed (<%= percent %>%)</div>
							<div class="progress-bar">
								<div class="progress-fill" data-percent="<%= percent %>"></div>
							</div>
							<ul>
								<% c.items.forEach((item, i) => { %>
									<li>
										<input type="checkbox" <%= item.completed ? 'checked' : '' %> onchange="updateItem('<%= c._id %>', <%= i %>, this.checked)">
										<%= item.text %>
									</li>
								<% }); %>
							</ul>
						</section>
					<% }); %>
					<% userChecklists.forEach(c => { %>
						<% const percent = Math.round((c.items.filter(item => item.completed).length / c.items.length) * 100); %>
						<section class="checklist">
							<h2><%= c.title %></h2>
							<div class="progress-text"><%= c.items.filter(item => item.completed).length %>/<%= c.items.length %> completed (<%= percent %>%)</div>
							<div class="progress-bar">
								<div class="progress-fill" data-percent="<%= percent %>"></div>
							</div>
							<ul>
								<% c.items.forEach((item, i) => { %>
									<li>
										<input type="checkbox" <%= item.completed ? 'checked' : '' %> onchange="updateItem('<%= c._id %>', <%= i %>, this.checked)">
										<%= item.text %>
									</li>
								<% }); %>
							</ul>
						</section>
					<% }); %>
					<% if (['admin', 'manager'].includes(user.accountType)) { %>
						<h2>Assign Checklist to User</h2>
						<form method="post" action="/checklists/assign">
							<input name="title" placeholder="Checklist Title" required />
							<textarea name="items" placeholder="Items (one per line)" required></textarea>
							<input name="userId" placeholder="User Email" required />
							<button type="submit">Assign</button>
						</form>
					<% } %>
					<% if (assignedChecklists && assignedChecklists.length > 0) { %>
						<h2>Assigned Checklists</h2>
						<% assignedChecklists.forEach(c => { %>
							<% const percent = Math.round((c.items.filter(item => item.completed).length / c.items.length) * 100); %>
							<section class="checklist">
								<h3><%= c.title %> (Assigned by <%= c.assignedBy %>)</h3>
								<div class="progress-text"><%= c.items.filter(item => item.completed).length %>/<%= c.items.length %> completed (<%= percent %>%)</div>
								<div class="progress-bar">
									<div class="progress-fill" data-percent="<%= percent %>"></div>
								</div>
								<ul>
									<% c.items.forEach((item, i) => { %>
										<li>
											<input type="checkbox" <%= item.completed ? 'checked' : '' %> onchange="updateItem('<%= c._id %>', <%= i %>, this.checked)">
											<%= item.text %>
										</li>
									<% }); %>
								</ul>
							</section>
						<% }); %>
					<% } %>
				</article>
			</div>
			<%- include('footer') %>
		</div>
		<script>
			document.querySelectorAll('.progress-fill').forEach(el => {
				el.style.width = el.dataset.percent + '%';
			});
			async function updateItem(id, index, completed) {
				await fetch('/checklists/update', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ id, index, completed })
				});
				location.reload();
			}
		</script>
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>
	</body>
</html>